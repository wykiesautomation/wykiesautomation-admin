/** Admin Web App â€” Auth + Products Upsert */
const ORIGIN_WHITELIST=['https://admin.wykiesautomation.co.za'];
function doGet(e){return handle_(e);}function doPost(e){return handle_(e);}function doOptions(e){return buildResponse_({ok:true},204,e);}function handle_(e){const path=(e.parameter.path||'').toString();if(e?.parameter?.sheetId)PropertiesService.getScriptProperties().setProperty('SHEET_ID',e.parameter.sheetId);if(path==='/auth/login'&&e.postData)return authLogin_(e);if(path==='/cms/products'&&!(e.postData))return productsList_(e);if(path==='/cms/products'&&e.postData)return productsUpsert_(e);return buildResponse_({message:'Not found'},404,e);}function getSheet_(){const id=PropertiesService.getScriptProperties().getProperty('SHEET_ID');return SpreadsheetApp.openById(id);}function productsList_(e){try{requireAuth_(e);}catch(err){return buildResponse_({message:err.message},401,e);}const ss=getSheet_();const sh=ss.getSheetByName('Products');const rows=sh.getDataRange().getValues();const [header,...data]=rows;const idx=Object.fromEntries(header.map((h,i)=>[h,i]));const items=data.filter(r=>r[idx['code']]).map(r=>({code:r[idx['code']],name:r[idx['name']],price:r[idx['price']],image:r[idx['image']]}));return buildResponse_(items,200,e);}function productsUpsert_(e){try{requireAuth_(e);}catch(err){return buildResponse_({message:err.message},401,e);}const ss=getSheet_();const sh=ss.getSheetByName('Products');const payload=JSON.parse(e.postData.contents);const {code,name,price,image}=payload;if(!code)return buildResponse_({message:'Missing code'},400,e);const rng=sh.getDataRange();const values=rng.getValues();const header=values[0];const idx=Object.fromEntries(header.map((h,i)=>[h,i]));let rowIndex=values.findIndex((r,i)=>i>0&&r[idx['code']]===code);if(rowIndex<0){sh.appendRow([code,name,price,image]);}else{const r=rowIndex+1;if(name!==undefined)sh.getRange(r,idx['name']+1).setValue(name);if(price!==undefined)sh.getRange(r,idx['price']+1).setValue(price);if(image!==undefined)sh.getRange(r,idx['image']+1).setValue(image);}return buildResponse_({message:'Saved'},200,e);}function requireAuth_(e){const secret=PropertiesService.getScriptProperties().getProperty('ADMIN_SECRET')||'';const hdr=e?.parameter?.Authorization||(e?.postData?.type==='application/json'?JSON.parse(e.postData.contents).Authorization:null);const auth=hdr||(e?.headers&&e.headers['Authorization']);const bearer=(auth||'').replace(/^Bearer\s+/i,'');if(!bearer)throw new Error('Missing token');const parts=bearer.split('.');if(parts.length!==3)throw new Error('Bad token');const [h,p,sig]=parts;const check=Utilities.base64EncodeWebSafe(Utilities.computeHmacSha256Signature(`${h}.${p}`,secret));if(sig!==check)throw new Error('Invalid signature');const payload=JSON.parse(Utilities.newBlob(Utilities.base64DecodeWebSafe(p)).getDataAsString());const now=Math.floor(Date.now()/1000);if(payload.exp&&payload.exp<now)throw new Error('Token expired');return payload;}function authLogin_(e){const payload=JSON.parse(e.postData.contents);const {email,password}=payload;const adminEmail='wykiesautomation@gmail.com';const secret=PropertiesService.getScriptProperties().getProperty('ADMIN_SECRET');const savedHash=PropertiesService.getScriptProperties().getProperty('ADMIN_HASH');if(!secret)return buildResponse_({message:'Server not configured'},500,e);const okEmail=email&&email.toLowerCase()===adminEmail;const okPass=savedHash&&Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256,password).map(b=>('0'+(b&0xFF).toString(16)).slice(-2)).join('')===savedHash;if(!(okEmail&&okPass))return buildResponse_({message:'Invalid credentials'},401,e);const header=Utilities.base64EncodeWebSafe(JSON.stringify({alg:'HS256',typ:'JWT'}));const now=Math.floor(Date.now()/1000);const body=Utilities.base64EncodeWebSafe(JSON.stringify({sub:email,iat:now,exp:now+3600}));const sig=Utilities.base64EncodeWebSafe(Utilities.computeHmacSha256Signature(`${header}.${body}`,secret));return buildResponse_({token:`${header}.${body}.${sig}`},200,e);}function buildResponse_(body,status,e){const origin=(e?.parameter?.origin)||(e?.headers&&e.headers['Origin'])||'';const allow=ORIGIN_WHITELIST.includes(origin)?origin:'*';return ContentService.createTextOutput(typeof body==='string'?body:JSON.stringify(body)).setMimeType(ContentService.MimeType.JSON).setHeaders({'Access-Control-Allow-Origin':allow,'Access-Control-Allow-Methods':'GET,POST,OPTIONS','Access-Control-Allow-Headers':'Content-Type,Authorization'}).setStatusCode(status||200);}