(function(){const loginForm=document.getElementById('loginForm');const loginStatus=document.getElementById('loginStatus');const app=document.getElementById('app');const authSection=document.getElementById('auth');const logoutBtn=document.getElementById('logoutBtn');const productForm=document.getElementById('productForm');const productList=document.getElementById('productList');const productStatus=document.getElementById('productStatus');const TOKEN_KEY='wa_admin_token';function setLoggedIn(token){localStorage.setItem(TOKEN_KEY,token);authSection.classList.add('hidden');app.classList.remove('hidden');loadProducts();}function logout(){localStorage.removeItem(TOKEN_KEY);authSection.classList.remove('hidden');app.classList.add('hidden');}async function login(e){e.preventDefault();loginStatus.textContent='Authenticating…';const payload=Object.fromEntries(new FormData(loginForm).entries());try{const res=await fetch(`${WA_CONFIG.apiBase}?path=/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});const out=await res.json();if(out&&out.token){setLoggedIn(out.token);loginStatus.textContent='';}else{throw new Error(out?.message||'Login failed');}}catch(err){loginStatus.textContent=err.message;}}async function loadProducts(){productList.innerHTML='Loading…';try{const res=await fetch(`${WA_CONFIG.apiBase}?path=/cms/products&sheetId=${encodeURIComponent(WA_CONFIG.sheetId)}`,{headers:{'Authorization':'Bearer '+(localStorage.getItem(TOKEN_KEY)||'')}});const data=await res.json();if(!Array.isArray(data))throw new Error('Bad response');productList.innerHTML=data.map(p=>`<div class='row'><div>${p.code}</div><input value='${p.name||''}' data-field='name' data-code='${p.code}'/><input value='${p.price||''}' data-field='price' data-code='${p.code}' type='number' step='0.01'/><input value='${p.image||''}' data-field='image' data-code='${p.code}'/><button data-save='${p.code}'>Save</button></div>`).join('');productList.addEventListener('click',async(e)=>{const btn=e.target.closest('[data-save]');if(!btn)return;const code=btn.getAttribute('data-save');const rowInputs=productList.querySelectorAll(`[data-code="${code}"]`);const payload={code};rowInputs.forEach(i=>payload[i.getAttribute('data-field')]=i.value);productStatus.textContent='Saving…';try{const res=await fetch(`${WA_CONFIG.apiBase}?path=/cms/products&sheetId=${encodeURIComponent(WA_CONFIG.sheetId)}`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+(localStorage.getItem(TOKEN_KEY)||'')},body:JSON.stringify(payload)});const out=await res.json();productStatus.textContent=out?.message||'Saved';}catch(err){productStatus.textContent='Save failed';}},{once:true});}catch(err){productList.innerHTML='Failed to load products.';}}async function createOrUpdateProduct(e){e.preventDefault();const payload=Object.fromEntries(new FormData(productForm).entries());productStatus.textContent='Saving…';try{const res=await fetch(`${WA_CONFIG.apiBase}?path=/cms/products&sheetId=${encodeURIComponent(WA_CONFIG.sheetId)}`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+(localStorage.getItem(TOKEN_KEY)||'')},body:JSON.stringify(payload)});const out=await res.json();productStatus.textContent=out?.message||'Saved';productForm.reset();loadProducts();}catch(err){productStatus.textContent='Save failed';}}loginForm.addEventListener('submit',login);logoutBtn.addEventListener('click',logout);productForm.addEventListener('submit',createOrUpdateProduct);if(localStorage.getItem(TOKEN_KEY)){authSection.classList.add('hidden');app.classList.remove('hidden');loadProducts();}})();