<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wykies Admin</title>
<style>
  :root { --bg:#0f141a; --panel:#1f2933; --muted:#9aa5b1; --brand:#2F76FF; --ok:#19c37d; --danger:#ff4d4f; --border:#243041; }
  body { margin:0; background:#0b1117; color:#e6edf3; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  header { display:flex; align-items:center; gap:.8rem; padding:12px 16px; border-bottom:1px solid var(--border); background:#0f141a; position:sticky; top:0; z-index:2; }
  header .logo { display:flex; align-items:center; gap:.6rem; font-weight:700; }
  header .logo .dot { width:28px; height:28px; border-radius:8px; background:var(--brand); display:inline-flex; align-items:center; justify-content:center; font-weight:800; }
  .layout { display:grid; grid-template-columns:260px 1fr; min-height:calc(100vh - 56px); }
  nav { border-right:1px solid var(--border); background:#0f141a; padding:12px; position:sticky; top:56px; height:calc(100vh - 56px); overflow:auto; }
  nav a { display:block; padding:10px 12px; border-radius:8px; color:#c8d1dc; text-decoration:none; margin:4px 0; }
  nav a.active, nav a:hover { background:#101826; color:#fff; }
  main { padding:18px; }
  .panel { background:#0f141a; border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
  h2 { margin:0 0 12px; font-size:20px; }
  table { width:100%; border-collapse:collapse; }
  th, td { text-align:left; border-bottom:1px solid var(--border); padding:10px; font-size:14px; }
  .btn { background:#162235; border:1px solid var(--border); color:#e6edf3; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn.primary { background:var(--brand); border-color:transparent; color:white; }
  .btn.danger { background:#2a1215; border-color:#431418; color:#ffccc7; }
  .stack { display:flex; gap:8px; flex-wrap:wrap; }
  .grid { display:grid; gap:12px; }
  .grid.cols-2 { grid-template-columns:1fr 1fr; }
  .grid.cols-3 { grid-template-columns:repeat(3, 1fr); }
  input, select, textarea { width:100%; background:#0b1117; border:1px solid var(--border); color:#e6edf3; border-radius:8px; padding:8px 10px; }
  .thumb { width:72px; height:72px; object-fit:cover; border-radius:8px; border:1px solid var(--border); }
  .muted { color:#9aa5b1; }
</style>
</head>
<body>
<header>
  <div class="logo"><span class="dot">WA</span> <span>Admin</span></div>
  <div style="margin-left:auto;">
    <button class="btn" id="googleSignIn">Sign in with Google</button>
    <span class="muted">Allowlist: <b>wykiesautomation@gmail.com</b></span>
  </div>
</header>

<div class="layout">
  <nav id="nav">
    <a href="#dashboard" data-id="dashboard">Dashboard</a>
    <a href="#prices" data-id="prices">Price Log</a>
    <a href="#payments" data-id="payments">Payments</a>
    <a href="#pages" data-id="pages">Pages</a>
    <a href="#settings" data-id="settings">Settings</a>
    <a href="#audit" data-id="audit">Audit</a>
    <a href="#products" id="nav-products" data-id="products">Products</a>
    <a href="#gallery"  id="nav-gallery"  data-id="gallery">Gallery</a>
  </nav>
  <main id="root"></main>
</div>

<script>if (typeof window.viewsview === 'undefined') { window.viewsview = {}; }</script>
<script>
const UPLOAD_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHuhjZ7YP7XMfJVrPlaBimM8dOweFtb6dCOe8QUOZlYAllepuSuJU7F52kzd20eMJZgQ/exec";
const ALLOWLIST = ["wykiesautomation@gmail.com"];
const state = { user:null, products:[], gallery:[] };
(function(){ if (location.search.includes('test=1')) state.user={ email:'wykiesautomation@gmail.com' }; })();
const routes=[{id:'dashboard',label:'Dashboard',render:renderDashboard},{id:'products',label:'Products',render:renderProducts},{id:'gallery',label:'Gallery',render:renderGallery},{id:'prices',label:'Price Log',render:renderPrices},{id:'payments',label:'Payments',render:renderPayments},{id:'pages',label:'Pages',render:renderPages},{id:'settings',label:'Settings',render:renderSettings},{id:'audit',label:'Audit',render:renderAudit}];
function h(html){const t=document.createElement('template');t.innerHTML=html.trim();return t.content.firstElementChild;}
function mountNav(){const nav=document.getElementById('nav');[...nav.querySelectorAll('a')].forEach(a=>{a.addEventListener('click',e=>{e.preventDefault();location.hash=a.getAttribute('data-id')||a.getAttribute('href').replace('#','');renderRoute();});});}
function setActive(id){[...document.querySelectorAll('nav a')].forEach(a=>{const aid=a.getAttribute('data-id')||a.getAttribute('href').replace('#','');a.classList.toggle('active',aid===id);});}
function renderRoute(){const id=location.hash.replace('#','')||'dashboard';const r=routes.find(x=>x.id===id)||routes[0];setActive(r.id);const root=document.getElementById('root');root.innerHTML='';try{r.render(root);}catch(e){root.appendChild(h(`<div class=\"panel\" style=\"border:1px solid #51221e;background:#1a1212\"><h2>Render error</h2><div>${e.name}: ${e.message}</div></div>`));console.error(e);}}
function renderDashboard(root){root.appendChild(h(`<section class=\"panel\"><h2>Today’s Sales</h2><div class=\"muted\">R 0</div></section>`));root.appendChild(h(`<section class=\"panel\"><h2>Queue Health</h2><div class=\"muted\">OK</div></section>`));}
function renderPrices(root){root.appendChild(h(`<section class=\"panel\"><h2>Price Log</h2><div class=\"muted\">Append-only: product_id, old, new, who, when, note</div><table><thead><tr><th>When</th><th>Product</th><th>Old</th><th>New</th><th>Who</th><th>Note</th></tr></thead><tbody id=\"priceLogBody\"></tbody></table></section>`));}
function renderPayments(root){root.appendChild(h(`<section class=\"panel\"><h2>Payments</h2><table><thead><tr><th>Date</th><th>Order</th><th>Email</th><th>Total</th><th>Status</th><th></th></tr></thead><tbody id=\"paymentsBody\"></tbody></table></section>`));}
function renderPages(root){root.appendChild(h(`<section class=\"panel\"><h2>Pages (Markdown)</h2><div class=\"grid cols-2\"><div><label>Slug<input id=\"pageSlug\" placeholder=\"privacy\"/></label></div><div><label>Title<input id=\"pageTitle\" placeholder=\"Privacy (POPIA)\"/></label></div></div><label>Content<textarea id=\"pageContent\" rows=\"8\">## Privacy (POPIA)\\nWe collect contact and order details to process sales via PayFast…</textarea></label><div class=\"stack\" style=\"margin-top:8px;\"><button class=\"btn primary\">Save</button><button class=\"btn\">Preview</button></div></section>`));}
function renderSettings(root){root.appendChild(h(`<section class=\"panel\"><h2>Settings</h2><div class=\"grid cols-3\"><div><label>Company Name<input/></label></div><div><label>VAT Number<input/></label></div><div><label>Support Email<input/></label></div></div></section>`));}
function renderAudit(root){root.appendChild(h(`<section class=\"panel\"><h2>Audit Log</h2><div class=\"muted\">No entries yet.</div></section>`));}
function renderProducts(root){const s=h(`<section class=\"panel\"><h2>Products</h2><div class=\"grid cols-3\" style=\"margin-bottom:8px;\"><div><label>Name<input id=\\\"pName\\\" placeholder=\\\"Product name\\\"></label></div><div><label>Price (incl VAT)<input id=\\\"pPrice\\\" type=\\\"number\\\" min=\\\"0\\\" step=\\\"0.01\\\" placeholder=\\\"1299.00\\\"></label></div><div><label>Status<select id=\\\"pStatus\\\"><option>Active</option><option>Hidden</option><option>Draft</option></select></label></div></div><div class=\"grid cols-2\" style=\"margin-bottom:8px;\"><div><label>Images<input id=\\\"pFiles\\\" type=\\\"file\\\" accept=\\\"image/*\\\" multiple></label><div class=\\\"muted\\\">Select multiple images; they upload to Drive.</div><div id=\\\"pThumbs\\\" class=\\\"stack\\\" style=\\\"margin-top:8px;\\\"></div></div><div><label>Notes<textarea id=\\\"pNotes\\\" rows=\\\"5\\\"></textarea></label></div></div><div class=\\\"stack\\\"><button id=\\\"btnUploadProductFiles\\\" class=\\\"btn\\\">Upload files</button><button id=\\\"btnAddProduct\\\" class=\\\"btn primary\\\">Add Product</button></div><div style=\\\"margin-top:16px;\\\"><table><thead><tr><th>ID</th><th>Name</th><th>Price (incl VAT)</th><th>Images</th><th>Status</th><th></th></tr></thead><tbody id=\\\"productsBody\\\"></tbody></table></div></section>`);root.appendChild(s);const pf=s.querySelector('#pFiles'),pt=s.querySelector('#pThumbs'),ub=s.querySelector('#btnUploadProductFiles'),ab=s.querySelector('#btnAddProduct'),nm=s.querySelector('#pName'),pr=s.querySelector('#pPrice'),st=s.querySelector('#pStatus'),tb=s.querySelector('#productsBody');let staged=[];pf.addEventListener('change',()=>{pt.innerHTML='';[...pf.files].forEach(f=>{const u=URL.createObjectURL(f);pt.appendChild(h(`<img class=\\\"thumb\\\" src=\\\"${u}\\\" alt=\\\"${f.name}\\\">`));});});ub.addEventListener('click',async()=>{if(!pf.files?.length){alert('Choose files first');return;}const res=await uploadFiles(pf.files);if(!res?.ok)return;staged=res.files;alert(`Uploaded ${staged.length} file(s).`);});ab.addEventListener('click',()=>{const id=(crypto?.randomUUID&&crypto.randomUUID())||String(Date.now());state.products.unshift({id,name:nm.value.trim(),price:Number(pr.value||0),status:st.value,images:staged});render();pf.value='';pt.innerHTML='';staged=[];nm.value='';pr.value='';st.value='Active';});function render(){tb.innerHTML='';state.products.forEach(p=>{const imgs=(p.images||[]).map(i=>`<img class=\\\"thumb\\\" src=\\\"${i.url}\\\" title=\\\"${i.name}\\\">`).join('');const r=h(`<tr><td>${String(p.id).slice(0,8)}</td><td>${p.name}</td><td>R ${Number(p.price).toFixed(2)}</td><td class=\\\"stack\\\">${imgs||'<span class=\\\"muted\\\">No images</span>'}</td><td>${p.status}</td><td><button class=\\\"btn danger\\\" data-id=\\\"${p.id}\\\">Delete</button></td></tr>`);r.querySelector('button').addEventListener('click',()=>{state.products=state.products.filter(x=>x.id!==p.id);render();});tb.appendChild(r);});}render();}
function renderGallery(root){const s=h(`<section class=\\\"panel\\\"><h2>Gallery</h2><div class=\\\"grid cols-3\\\"><div><label>Images<input id=\\\\\\\"gFiles\\\\\\\" type=\\\\\\\"file\\\\\\\" accept=\\\\\\\"image/*\\\\\\\" multiple></label></div><div><label>Caption<input id=\\\\\\\"gCaption\\\\\\\" placeholder=\\\\\\\"Short caption\\\\\\\"></label></div><div><label>Tags (comma-separated)<input id=\\\\\\\"gTags\\\\\\\" placeholder=\\\\\\\"esp32,gsm,gates\\\\\\\"></label></div></div><div class=\\\\\\\"stack\\\\\\\" style=\\\\\\\"margin-top:8px;\\\\\\\"><button id=\\\\\\\"btnUploadGallery\\\\\\\" class=\\\\\\\"btn primary\\\\\\\">Upload to Gallery</button></div><div id=\\\\\\\"gThumbs\\\\\\\" class=\\\\\\\"stack\\\\\\\" style=\\\\\\\"margin-top:12px;\\\\\\\"></div><div style=\\\\\\\"margin-top:16px;\\\\\\\"><table><thead><tr><th>Preview</th><th>Caption</th><th>Tags</th><th>URL</th><th></th></tr></thead><tbody id=\\\\\\\"galleryBody\\\\\\\"></tbody></table></div></section>`);root.appendChild(s);const fe=s.querySelector('#gFiles'),te=s.querySelector('#gThumbs'),ub=s.querySelector('#btnUploadGallery'),tb=s.querySelector('#galleryBody');fe.addEventListener('change',()=>{te.innerHTML='';[...fe.files].forEach(f=>{const u=URL.createObjectURL(f);te.appendChild(h(`<img class=\\\\\\\"thumb\\\\\\\" src=\\\\\\\"${u}\\\\\\\" alt=\\\\\\\"${f.name}\\\\\\\">`));});});ub.addEventListener('click',async()=>{if(!fe.files?.length){alert('Choose images first.');return;}const c=s.querySelector('#gCaption').value.trim();const tags=(s.querySelector('#gTags').value||'').split(',').map(x=>x.trim()).filter(Boolean);const res=await uploadFiles(fe.files);if(!res?.ok)return;res.files.forEach(f=>{state.gallery.unshift({id:f.id,url:f.url,name:f.name,caption:c,tags:tags});});render();fe.value='';te.innerHTML='';s.querySelector('#gCaption').value='';s.querySelector('#gTags').value='';});function render(){tb.innerHTML='';state.gallery.forEach(g=>{const r=h(`<tr><td><img class=\\\\\\\"thumb\\\\\\\" src=\\\\\\\"${g.url}\\\\\\\" alt=\\\\\\\"${g.name}\\\\\\\"></td><td>${g.caption||'<span class=\\\\\\\\\\\\\\\"muted\\\\\\\\\\\\\\\">—</span>'}</td><td>${(g.tags||[]).map(t=>`<span style=\\\\\\\"background:#101826;border:1px solid #243041;color:#c8d1dc;padding:2px 8px;border-radius:999px;font-size:12px;\\\\\\\">${t}</span>`).join('')}</td><td><a href=\\\\\\\"${g.url}\\\\\\\" target=\\\\\\\"_blank\\\\\\\">${g.url}</a></td><td><button class=\\\\\\\"btn danger\\\\\\\" data-id=\\\\\\\"${g.id}\\\\\\\">Remove</button></td></tr>`);r.querySelector('button').addEventListener('click',()=>{state.gallery=state.gallery.filter(x=>x.id!==g.id);render();});tb.appendChild(r);});}render();}
async function uploadFiles(files){if(!state.user){alert('Please sign in first.');return {ok:false};}if(!ALLOWLIST.includes(state.user.email)){alert('Not allowed.');return {ok:false};}const fd=new FormData();[...files].forEach(f=>fd.append('files',f));fd.append('u',state.user.email);const res=await fetch(UPLOAD_SCRIPT_URL,{method:'POST',body:fd,mode:'cors'});if(!res.ok){const txt=await res.text().catch(()=>'(no body)');alert('Upload failed: '+txt);return {ok:false};}return await res.json();}
document.getElementById('googleSignIn').addEventListener('click',()=>{const email=prompt('Enter admin email','wykiesautomation@gmail.com');if(!email)return;if(!ALLOWLIST.includes(email)){alert('Not allowed');return;}state.user={email};alert('Signed in as '+email);});
mountNav();renderRoute();window.addEventListener('hashchange',renderRoute);
</script>
</body>
</html>