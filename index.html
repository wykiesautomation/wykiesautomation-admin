
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wykies Admin</title>
<style>
  :root { --bg:#0f141a; --panel:#1f2933; --muted:#9aa5b1; --brand:#2F76FF; --ok:#19c37d; --danger:#ff4d4f; --border:#243041; }
  body { margin:0; background:#0b1117; color:#e6edf3; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  header { display:flex; align-items:center; gap:.8rem; padding:12px 16px; border-bottom:1px solid var(--border); background:#0f141a; position:sticky; top:0; z-index:2; }
  header .logo { display:flex; align-items:center; gap:.6rem; font-weight:700; }
  header .logo .dot { width:28px; height:28px; border-radius:8px; background:var(--brand); display:inline-flex; align-items:center; justify-content:center; font-weight:800; }
  .layout { display:grid; grid-template-columns:260px 1fr; min-height:calc(100vh - 56px); }
  nav { border-right:1px solid var(--border); background:#0f141a; padding:12px; position:sticky; top:56px; height:calc(100vh - 56px); overflow:auto; }
  nav a { display:block; padding:10px 12px; border-radius:8px; color:#c8d1dc; text-decoration:none; margin:4px 0; }
  nav a.active, nav a:hover { background:#101826; color:#fff; }
  main { padding:18px; }
  .panel { background:#0f141a; border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
  h2 { margin:0 0 12px; font-size:20px; }
  table { width:100%; border-collapse:collapse; }
  th, td { text-align:left; border-bottom:1px solid var(--border); padding:10px; font-size:14px; }
  .btn { background:#162235; border:1px solid var(--border); color:#e6edf3; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn.primary { background:var(--brand); border-color:transparent; color:white; }
  .btn.danger { background:#2a1215; border-color:#431418; color:#ffccc7; }
  .stack { display:flex; gap:8px; flex-wrap:wrap; }
  .grid { display:grid; gap:12px; }
  .grid.cols-2 { grid-template-columns:1fr 1fr; }
  .grid.cols-3 { grid-template-columns:repeat(3, 1fr); }
  input, select, textarea { width:100%; background:#0b1117; border:1px solid var(--border); color:#e6edf3; border-radius:8px; padding:8px 10px; }
  .thumb { width:72px; height:72px; object-fit:cover; border-radius:8px; border:1px solid var(--border); }
  .muted { color:var(--muted); }
  .chips { display:flex; gap:8px; flex-wrap:wrap; }
  .chip { background:#101826; border:1px solid var(--border); color:#c8d1dc; padding:2px 8px; border-radius:999px; font-size:12px; }
  .hint { font-size:12px; color:#9aa5b1; }
  pre { background:#0b1117; border:1px solid var(--border); border-radius:12px; padding:12px; overflow:auto; }
</style>
</head>
<body>
<header>
  <div class="logo"><span class="dot">WA</span> <span>Admin</span></div>
  <div style="margin-left:auto;">
    <button class="btn" id="googleSignIn">Sign in with Google</button>
    <span class="hint">Allowlist: <b>wykiesautomation@gmail.com</b></span>
  </div>
</header>

<div class="layout">
  <nav id="nav">
    <!-- Existing nav items can remain; we add two new links below -->
    <a href="#dashboard" data-id="dashboard">Dashboard</a>
    <a href="#prices" data-id="prices">Price Log</a>
    <a href="#payments" data-id="payments">Payments</a>
    <a href="#pages" data-id="pages">Pages</a>
    <a href="#settings" data-id="settings">Settings</a>
    <a href="#audit" data-id="audit">Audit</a>
    <!-- Added nav items -->
    <a href="#products" id="nav-products" data-id="products">Products</a>
    <a href="#gallery"  id="nav-gallery"  data-id="gallery">Gallery</a>
  </nav>
  <main id="root"></main>
</div>

<!-- Guard for missing variable to avoid ReferenceError: viewsview is not defined -->
<script>
if (typeof window.viewsview === 'undefined') { window.viewsview = {}; }
</script>

<script>
/** ========= CONFIG ========= */
const UPLOAD_SCRIPT_URL = "PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE"; // <-- replace after deploying Apps Script
const ALLOWLIST = ["wykiesautomation@gmail.com"]; // add more emails if needed

/** ========= STATE ========= */
const state = {
  user: null,
  products: [],
  gallery: []
};

/** ========= AUTO TEST SIGN-IN ========= */
(function(){
  if (location.search.includes('test=1')) {
    state.user = { email: 'wykiesautomation@gmail.com' };
    console.log('Test mode: signed in as', state.user.email);
  }
})();

/** ========= NAV + ROUTER ========= */
const routes = [
  { id: "dashboard", label: "Dashboard", render: renderDashboard },
  { id: "products",  label: "Products",  render: renderProducts },
  { id: "gallery",   label: "Gallery",   render: renderGallery },
  { id: "prices",    label: "Price Log", render: renderPrices },
  { id: "payments",  label: "Payments",  render: renderPayments },
  { id: "pages",     label: "Pages",     render: renderPages },
  { id: "settings",  label: "Settings",  render: renderSettings },
  { id: "audit",     label: "Audit",     render: renderAudit },
];

function h(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; }
function mountNav(){
  const nav = document.getElementById('nav');
  // leave existing anchors; ensure active state toggles work
  [...nav.querySelectorAll('a')].forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      location.hash = a.getAttribute('data-id') || a.getAttribute('href').replace('#','');
      renderRoute();
    });
  });
}
function setActive(id){
  [...document.querySelectorAll('nav a')].forEach(a=>{
    const aid = a.getAttribute('data-id') || a.getAttribute('href').replace('#','');
    a.classList.toggle('active', aid===id);
  });
}
function renderRoute(){
  const id = location.hash.replace('#','') || 'dashboard';
  const route = routes.find(r=>r.id===id) || routes[0];
  setActive(route.id);
  const root = document.getElementById('root');
  root.innerHTML = "";
  try { route.render(root); }
  catch(e){
    root.appendChild(h(`<div class="panel" style="border-color:#51221e;background:#1a1212">
      <h2>Render error</h2>
      <div class="muted">${e.name}: ${e.message}</div>
    </div>`));
    console.error(e);
  }
}

/** ========= PAGES ========= */
function renderDashboard(root){
  root.appendChild(h(`<section class="panel"><h2>Today’s Sales</h2><div class="muted">R 0</div></section>`));
  root.appendChild(h(`<section class="panel"><h2>Queue Health</h2><div class="chip">OK</div></section>`));
}
function renderPrices(root){
  root.appendChild(h(`<section class="panel"><h2>Price Log</h2>
    <div class="muted">Append-only: product_id, old, new, who, when, note</div>
    <table><thead><tr><th>When</th><th>Product</th><th>Old</th><th>New</th><th>Who</th><th>Note</th></tr></thead><tbody id="priceLogBody"></tbody></table>
  </section>`));
}
function renderPayments(root){
  root.appendChild(h(`<section class="panel"><h2>Payments</h2>
    <table><thead><tr><th>Date</th><th>Order</th><th>Email</th><th>Total</th><th>Status</th><th></th></tr></thead><tbody id="paymentsBody"></tbody></table>
  </section>`));
}
function renderPages(root){
  root.appendChild(h(`<section class="panel"><h2>Pages (Markdown)</h2>
    <div class="grid cols-2"><div><label>Slug<input id="pageSlug" placeholder="privacy"/></label></div>
    <div><label>Title<input id="pageTitle" placeholder="Privacy (POPIA)"/></label></div></div>
    <label>Content (Markdown)<textarea id="pageContent" rows="8">## Privacy (POPIA)
We collect contact and order details to process sales via PayFast…</textarea></label>
    <div class="stack" style="margin-top:8px;"><button class="btn primary">Save</button><button class="btn">Preview</button></div>
  </section>`));
}
function renderSettings(root){
  root.appendChild(h(`<section class="panel"><h2>Settings</h2>
    <div class="grid cols-3"><div><label>Company Name<input/></label></div><div><label>VAT Number<input/></label></div><div><label>Support Email<input/></label></div></div>
    <div class="grid cols-2" style="margin-top:8px;"><div><label>Logo<input type="file" id="logoFile" accept="image/*"></label></div><div><label>Brand Color<input type="color" value="#2F76FF"></label></div></div>
    <div style="margin-top:8px;"><button class="btn primary">Save Settings</button></div>
  </section>`));
}
function renderAudit(root){ root.appendChild(h(`<section class="panel"><h2>Audit Log</h2><div class="muted">No entries yet.</div></section>`)); }

/** ========= PRODUCTS (with upload) ========= */
function renderProducts(root){
  const section = h(`
    <section class="panel">
      <h2>Products</h2>
      <div class="grid cols-3" style="margin-bottom:8px;">
        <div><label>Name<input id="pName" placeholder="Product name"></label></div>
        <div><label>Price (incl VAT)<input id="pPrice" type="number" min="0" step="0.01" placeholder="1299.00"></label></div>
        <div><label>Status
          <select id="pStatus"><option>Active</option><option>Hidden</option><option>Draft</option></select>
        </label></div>
      </div>
      <div class="grid cols-2" style="margin-bottom:8px;">
        <div>
          <label>Images<input id="pFiles" type="file" accept="image/*" multiple></label>
          <div class="hint">Select multiple images; they upload to Drive.</div>
          <div id="pThumbs" class="stack" style="margin-top:8px;"></div>
        </div>
        <div><label>Notes (internal)<textarea id="pNotes" rows="5"></textarea></label></div>
      </div>
      <div class="stack"><button id="btnUploadProductFiles" class="btn">Upload files</button><button id="btnAddProduct" class="btn primary">Add Product</button></div>
      <div style="margin-top:16px;">
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Price (incl VAT)</th><th>Images</th><th>Status</th><th></th></tr></thead>
          <tbody id="productsBody"></tbody>
        </table>
      </div>
    </section>`);
  root.appendChild(section);

  const pFiles = section.querySelector('#pFiles');
  const pThumbs = section.querySelector('#pThumbs');
  const uploadBtn = section.querySelector('#btnUploadProductFiles');
  const addBtn = section.querySelector('#btnAddProduct');
  const nameEl = section.querySelector('#pName');
  const priceEl = section.querySelector('#pPrice');
  const statusEl = section.querySelector('#pStatus');
  const tbody = section.querySelector('#productsBody');

  let stagedImages = [];

  pFiles.addEventListener('change', () => {
    pThumbs.innerHTML = "";
    [...pFiles.files].forEach(file=>{
      const url = URL.createObjectURL(file);
      pThumbs.appendChild(h(`<img class="thumb" src="${url}" alt="${file.name}">`));
    });
  });

  uploadBtn.addEventListener('click', async ()=>{
    if (!pFiles.files?.length) return alert("Choose files first");
    const res = await uploadFiles(pFiles.files);
    if (!res?.ok) return;
    stagedImages = res.files; // [{id,url,name}]
    alert(`Uploaded ${stagedImages.length} file(s).`);
  });

  addBtn.addEventListener('click', ()=>{
    const id = (crypto?.randomUUID && crypto.randomUUID()) || String(Date.now());
    const product = {
      id,
      name: nameEl.value.trim(),
      price: Number(priceEl.value || 0),
      status: statusEl.value,
      images: stagedImages
    };
    state.products.unshift(product);
    renderProductsTable();
    // reset
    pFiles.value = ""; pThumbs.innerHTML = ""; stagedImages = []; nameEl.value = ""; priceEl.value=""; statusEl.value="Active";
  });

  function renderProductsTable(){
    tbody.innerHTML = "";
    state.products.forEach(p=>{
      const images = (p.images||[]).map(i=>`<img class="thumb" src="${i.url}" title="${i.name}">`).join("");
      const row = h(`<tr>
        <td>${String(p.id).slice(0,8)}</td>
        <td>${p.name}</td>
        <td>R ${Number(p.price).toFixed(2)}</td>
        <td class="stack">${images || '<span class="muted">No images</span>'}</td>
        <td>${p.status}</td>
        <td><button class="btn danger" data-id="${p.id}">Delete</button></td>
      </tr>`);
      row.querySelector('button').addEventListener('click', ()=>{
        state.products = state.products.filter(x=>x.id!==p.id);
        renderProductsTable();
      });
      tbody.appendChild(row);
    });
  }
}

/** ========= GALLERY (with upload) ========= */
function renderGallery(root){
  const section = h(`
    <section class="panel">
      <h2>Gallery</h2>
      <div class="grid cols-3">
        <div><label>Images<input id="gFiles" type="file" accept="image/*" multiple></label></div>
        <div><label>Caption<input id="gCaption" placeholder="Short caption"></label></div>
        <div><label>Tags (comma-separated)<input id="gTags" placeholder="esp32,gsm,gates"></label></div>
      </div>
      <div class="stack" style="margin-top:8px;"><button id="btnUploadGallery" class="btn primary">Upload to Gallery</button></div>
      <div id="gThumbs" class="stack" style="margin-top:12px;"></div>
      <div style="margin-top:16px;">
        <table>
          <thead><tr><th>Preview</th><th>Caption</th><th>Tags</th><th>URL</th><th></th></tr></thead>
          <tbody id="galleryBody"></tbody>
        </table>
      </div>
    </section>`);
  root.appendChild(section);

  const filesEl = section.querySelector('#gFiles');
  const thumbsEl = section.querySelector('#gThumbs');
  const uploadBtn = section.querySelector('#btnUploadGallery');
  const tbody = section.querySelector('#galleryBody');

  filesEl.addEventListener('change', ()=>{
    thumbsEl.innerHTML = "";
    [...filesEl.files].forEach(f=>{
      const url = URL.createObjectURL(f);
      thumbsEl.appendChild(h(`<img class="thumb" src="${url}" alt="${f.name}">`));
    });
  });

  uploadBtn.addEventListener('click', async ()=>{
    if (!filesEl.files?.length) return alert("Choose images first.");
    const caption = section.querySelector('#gCaption').value.trim();
    const tags = (section.querySelector('#gTags').value||"").split(",").map(x=>x.trim()).filter(Boolean);
    const res = await uploadFiles(filesEl.files);
    if (!res?.ok) return;
    res.files.forEach(f=>{ state.gallery.unshift({ id:f.id, url:f.url, name:f.name, caption, tags }); });
    renderGalleryTable();
    filesEl.value=""; thumbsEl.innerHTML=""; section.querySelector('#gCaption').value=""; section.querySelector('#gTags').value="";
  });

  function renderGalleryTable(){
    tbody.innerHTML = "";
    state.gallery.forEach(g=>{
      const row = h(`<tr>
        <td><img class="thumb" src="${g.url}" alt="${g.name}"></td>
        <td>${g.caption || '<span class="muted">—</span>'}</td>
        <td>${(g.tags||[]).map(t=>`<span class="chip">${t}</span>`).join("")}</td>
        <td><a href="${g.url}" target="_blank">${g.url}</a></td>
        <td><button class="btn danger" data-id="${g.id}">Remove</button></td>
      </tr>`);
      row.querySelector('button').addEventListener('click', ()=>{
        state.gallery = state.gallery.filter(x=>x.id!==g.id);
        renderGalleryTable();
      });
      tbody.appendChild(row);
    });
  }
}

/** ========= UPLOAD HELPER ========= */
async function uploadFiles(fileList){
  if (!state.user) { alert("Please sign in first."); return { ok:false }; }
  if (!ALLOWLIST.includes(state.user.email)) { alert("Not allowed."); return { ok:false }; }
  const fd = new FormData();
  [...fileList].forEach(f=>fd.append('files', f));
  fd.append('u', state.user.email);
  const res = await fetch(UPLOAD_SCRIPT_URL, { method:'POST', body:fd, mode:'cors' });
  if (!res.ok) { const txt = await res.text().catch(()=>"(no body)"); alert("Upload failed: " + txt); return { ok:false }; }
  const data = await res.json();
  return data; // {ok:true, files:[{id,url,name}]}
}

/** ========= AUTH PLACEHOLDER ========= */
document.getElementById('googleSignIn').addEventListener('click', ()=>{
  const email = prompt('Enter admin email', 'wykiesautomation@gmail.com');
  if (!email) return;
  if (!ALLOWLIST.includes(email)) { alert('Not allowed'); return; }
  state.user = { email };
  alert('Signed in as ' + email);
});

/** ========= INIT ========= */
mountNav();
renderRoute();
window.addEventListener('hashchange', renderRoute);
</script>

<!-- Legacy content preserved for reference -->
<section class="panel">
  <h2>Legacy Content (Preserved)</h2>
  <pre>
# Wykies Admin 
logo Admin [Dashboard](#dashboard) [Catalog](#catalog) [Price Log](#prices) [Payments](#payments) [Pages](#pages) [Settings](#settings) [Audit](#audit) 
Sign in with Google 
Allowlist: wykiesautomation@gmail.com
## Dashboard

Today’s Sales
R 0
Verified ITNs (24h)
0
Queue Health
OK
### Catalog

Add Product 
<table>
<tr>
<th> 
ID
<\/th>

 <th>Name
<\/th>
 <th>Price (incl VAT)
<\/th>
 <th>Images
<\/th>
 <th>Status
<\/th>
 <th> 
<\/th>
<\/tr>
<\/table>
### Price Log

Append-only: product_id, old, new, who, when, note
### Payments
<table>
<tr>
<th> 
Date
<\/th>

 <th>Order
<\/th>
 <th>Email
<\/th>
 <th>Total
<\/th>
 <th>Status
<\/th>
 <th> 
<\/th>
<\/tr>
<\/table>
### Pages (Markdown)

Slug Title Content (Markdown) ## Privacy (POPIA)\nWe collect contact and order details to process sales via PayFast… 
Save 
Preview
### Privacy (POPIA)

We collect contact and order details to process sales via PayFast…
### Settings

Company Name VAT Number Registered Address Support Email 
Logo Brand Color 
Save Settings
### Audit Log
</pre>
</section>

</body>
</html>
